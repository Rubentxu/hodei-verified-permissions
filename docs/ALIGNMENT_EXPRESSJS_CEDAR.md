# An√°lisis de Alineaci√≥n: Hodei SDK vs Cedar Authorization for Express.js

## üìä Resumen Ejecutivo

Este documento analiza c√≥mo nuestro SDK de Rust para Hodei Verified Permissions se alinea con las especificaciones del paquete oficial `@cedar-policy/authorization-for-expressjs` de AWS.

**Fecha:** 2025-10-21  
**Versi√≥n SDK:** 0.1.0  
**Referencia:** Cedar Authorization for Express.js

---

## ‚úÖ Caracter√≠sticas Implementadas

### 1. **Middleware de Autorizaci√≥n** ‚úÖ

| Caracter√≠stica | Express.js | Hodei Rust SDK | Estado |
|----------------|------------|----------------|--------|
| Middleware Layer | `ExpressAuthorizationMiddleware` | `VerifiedPermissionsLayer` | ‚úÖ Implementado |
| Tower/Axum Integration | N/A (Express) | S√≠ (Tower/Axum) | ‚úÖ Mejor integraci√≥n |
| Request Interception | S√≠ | S√≠ | ‚úÖ Equivalente |

**Implementaci√≥n:**
```rust
// Hodei SDK
let layer = VerifiedPermissionsLayer::new(
    client,
    "policy-store-123",
    "identity-source-456"
);

let app = Router::new()
    .route("/api/documents", get(list_documents))
    .layer(layer);
```

**Express.js:**
```javascript
const expressAuthorization = new ExpressAuthorizationMiddleware({
    schema: {...},
    authorizationEngine: cedarAuthorizationEngine,
    principalConfiguration: {...}
});

app.use(expressAuthorization.middleware);
```

---

### 2. **Configuraci√≥n de Schema** ‚úÖ

| Caracter√≠stica | Express.js | Hodei Rust SDK | Estado |
|----------------|------------|----------------|--------|
| Schema Support | JSON Schema | JSON Schema | ‚úÖ Compatible |
| Schema Validation | S√≠ | S√≠ (Cedar Engine) | ‚úÖ Implementado |
| Schema Format | `jsonString` | JSON String | ‚úÖ Compatible |

**Diferencias:**
- Express.js: Schema se pasa en configuraci√≥n del middleware
- Hodei: Schema se gestiona a trav√©s de `put_schema()` en el servidor

---

### 3. **Motor de Autorizaci√≥n** ‚úÖ

| Caracter√≠stica | Express.js | Hodei Rust SDK | Estado |
|----------------|------------|----------------|--------|
| Cedar Engine | `CedarInlineAuthorizationEngine` | Cedar Engine (servidor) | ‚úÖ Implementado |
| AVP Support | `AVPAuthorizationEngine` | S√≠ (compatible) | ‚úÖ Compatible |
| Custom Engine | S√≠ | S√≠ (trait-based) | ‚úÖ M√°s flexible |

**Arquitectura:**
- **Express.js:** Motor en el middleware (inline)
- **Hodei:** Motor en el servidor gRPC (centralizado)
- **Ventaja Hodei:** Cache centralizado, mejor rendimiento (~100Œºs)

---

### 4. **Configuraci√≥n de Principal** ‚ö†Ô∏è PARCIAL

| Caracter√≠stica | Express.js | Hodei Rust SDK | Estado |
|----------------|------------|----------------|--------|
| Identity Token | `{type: 'identityToken'}` | ‚úÖ JWT Token Support | ‚úÖ Implementado |
| Access Token | `{type: 'accessToken'}` | ‚úÖ JWT Token Support | ‚úÖ Implementado |
| Custom Extractor | `{type: 'custom', getPrincipalEntity}` | `AuthorizationRequestExtractor` trait | ‚ö†Ô∏è Diferente API |

**Express.js:**
```javascript
principalConfiguration: {
    type: 'custom',
    getPrincipalEntity: async (req) => {
        const user = req.user;
        return {
            uid: { type: 'PetStoreApp::User', id: user.sub },
            attrs: { ...user },
            parents: userGroups
        };
    }
}
```

**Hodei SDK:**
```rust
#[async_trait]
impl<B> AuthorizationRequestExtractor<B> for CustomExtractor {
    async fn extract(&self, req: &Request<B>) 
        -> Result<AuthorizationRequestParts, Self::Error> 
    {
        // Extract principal, action, resource
        Ok(AuthorizationRequestParts {
            principal: "User::alice".to_string(),
            action: "Action::read".to_string(),
            resource: "Document::doc123".to_string(),
            context: None,
        })
    }
}
```

**‚ö†Ô∏è GAP IDENTIFICADO:**
- Express.js permite configurar `getPrincipalEntity` que retorna entidades completas con atributos y padres
- Hodei SDK solo extrae identificadores (principal, action, resource)
- **Falta:** Soporte para extraer y pasar entidades completas con atributos

---

### 5. **Endpoints Excluidos** ‚ùå NO IMPLEMENTADO

| Caracter√≠stica | Express.js | Hodei Rust SDK | Estado |
|----------------|------------|----------------|--------|
| Skipped Endpoints | `skippedEndpoints: [{httpVerb, path}]` | ‚ùå No implementado | ‚ùå Falta |

**Express.js:**
```javascript
skippedEndpoints: [
    {httpVerb: 'get', path: '/login'},
    {httpVerb: 'get', path: '/api-spec/v3'},
]
```

**‚ö†Ô∏è GAP IDENTIFICADO:**
- No hay forma de excluir rutas espec√≠ficas de la autorizaci√≥n
- Todas las rutas bajo el middleware son autorizadas

---

### 6. **Configuraci√≥n de Contexto** ‚ö†Ô∏è PARCIAL

| Caracter√≠stica | Express.js | Hodei Rust SDK | Estado |
|----------------|------------|----------------|--------|
| Context Support | `contextConfiguration` (opcional) | `context: Option<serde_json::Value>` | ‚ö†Ô∏è B√°sico |

**Hodei SDK:**
```rust
pub struct AuthorizationRequestParts {
    pub principal: String,
    pub action: String,
    pub resource: String,
    pub context: Option<serde_json::Value>, // ‚úÖ Existe pero limitado
}
```

**‚ö†Ô∏è GAP IDENTIFICADO:**
- Existe soporte b√°sico para contexto
- No hay API clara para configurar c√≥mo se extrae el contexto
- Express.js permite `contextConfiguration` personalizable

---

### 7. **Logging** ‚úÖ IMPLEMENTADO

| Caracter√≠stica | Express.js | Hodei Rust SDK | Estado |
|----------------|------------|----------------|--------|
| Debug Logging | `logger.debug` | `tracing::debug!` | ‚úÖ Mejor |
| Standard Logging | `logger.log` | `tracing::info!` | ‚úÖ Mejor |
| Structured Logging | No | S√≠ (tracing) | ‚úÖ Superior |

**Ventaja Hodei:** Sistema de logging estructurado con `tracing`

---

### 8. **Manejo de Errores** ‚úÖ IMPLEMENTADO

| Caracter√≠stica | Express.js | Hodei Rust SDK | Estado |
|----------------|------------|----------------|--------|
| Error Types | JavaScript Errors | `MiddlewareError` enum | ‚úÖ Mejor tipado |
| HTTP Status Codes | S√≠ | `status_code()` method | ‚úÖ Implementado |
| Error Messages | S√≠ | `to_response_body()` | ‚úÖ Implementado |

**Hodei SDK:**
```rust
pub enum MiddlewareError {
    AuthorizationHeader(String),    // 401
    ExtractionFailed(String),        // 400
    AuthorizationFailed(String),     // 500
    AccessDenied(String),            // 403
    Internal(String),                // 500
}
```

---

## üî¥ Gaps Cr√≠ticos Identificados

### 1. **Extracci√≥n de Entidades Completas** üî¥ CR√çTICO

**Problema:**
- Express.js permite pasar entidades completas con atributos y jerarqu√≠a de padres
- Hodei SDK solo extrae identificadores de strings

**Impacto:**
- No se pueden evaluar pol√≠ticas que dependan de atributos de entidades
- Limitaci√≥n en pol√≠ticas complejas con condiciones `when`

**Soluci√≥n Propuesta:**
```rust
pub struct PrincipalEntity {
    pub uid: EntityIdentifier,
    pub attrs: HashMap<String, serde_json::Value>,
    pub parents: Vec<EntityIdentifier>,
}

pub struct AuthorizationRequestParts {
    pub principal: String,
    pub action: String,
    pub resource: String,
    pub context: Option<serde_json::Value>,
    // NUEVO:
    pub principal_entity: Option<PrincipalEntity>,
    pub entities: Vec<Entity>, // Entidades adicionales
}

#[async_trait]
pub trait AuthorizationRequestExtractor<B>: Send + Sync {
    async fn extract(&self, req: &Request<B>) 
        -> Result<AuthorizationRequestParts, Self::Error>;
    
    // NUEVO: M√©todo opcional para extraer entidades completas
    async fn extract_principal_entity(&self, req: &Request<B>) 
        -> Result<Option<PrincipalEntity>, Self::Error> 
    {
        Ok(None) // Default: no entities
    }
}
```

---

### 2. **Endpoints Excluidos** üü° IMPORTANTE

**Problema:**
- No hay forma de excluir rutas espec√≠ficas (ej: `/login`, `/health`)

**Soluci√≥n Propuesta:**
```rust
pub struct VerifiedPermissionsLayer {
    client: Arc<AuthorizationClient>,
    policy_store_id: String,
    identity_source_id: String,
    // NUEVO:
    skipped_endpoints: Vec<SkippedEndpoint>,
}

pub struct SkippedEndpoint {
    pub http_verb: String,
    pub path: String,
}

impl VerifiedPermissionsLayer {
    pub fn new(client: AuthorizationClient, policy_store_id: String) -> Self {
        // ...
    }
    
    // NUEVO:
    pub fn skip_endpoint(mut self, verb: &str, path: &str) -> Self {
        self.skipped_endpoints.push(SkippedEndpoint {
            http_verb: verb.to_lowercase(),
            path: path.to_string(),
        });
        self
    }
}
```

---

### 3. **Configuraci√≥n de Contexto** üü° IMPORTANTE

**Problema:**
- No hay API clara para configurar extracci√≥n de contexto

**Soluci√≥n Propuesta:**
```rust
pub trait ContextExtractor<B>: Send + Sync {
    async fn extract_context(&self, req: &Request<B>) 
        -> Result<Option<serde_json::Value>, Self::Error>;
}

pub struct VerifiedPermissionsLayer {
    // ...
    context_extractor: Option<Arc<dyn ContextExtractor<B>>>,
}
```

---

## üìà Ventajas de Hodei SDK sobre Express.js

### 1. **Arquitectura Centralizada** ‚úÖ
- Motor Cedar en servidor gRPC
- Cache centralizado (~100Œºs latency)
- Mejor para microservicios

### 2. **Type Safety** ‚úÖ
- Rust's type system
- Compile-time guarantees
- No runtime errors

### 3. **Performance** ‚úÖ
- ~100Œºs con cache vs ~ms en Express.js
- Zero-cost abstractions
- Async/await nativo

### 4. **Logging Estructurado** ‚úÖ
- Sistema `tracing` avanzado
- Mejor observabilidad
- Integraci√≥n con OpenTelemetry

### 5. **Multi-Database** ‚úÖ
- SQLite, PostgreSQL, SurrealDB
- Express.js: solo in-memory o custom

---

## üéØ Roadmap de Alineaci√≥n

### Fase 1: Gaps Cr√≠ticos (Sprint 1-2)
- [ ] Implementar extracci√≥n de entidades completas
- [ ] A√±adir soporte para `principal_entity` con atributos
- [ ] Actualizar `AuthorizationRequestExtractor` trait

### Fase 2: Configuraci√≥n Avanzada (Sprint 3)
- [ ] Implementar `skipped_endpoints`
- [ ] A√±adir `ContextExtractor` trait
- [ ] Mejorar API de configuraci√≥n

### Fase 3: Herramientas (Sprint 4)
- [ ] CLI para generar schema desde OpenAPI
- [ ] CLI para generar pol√≠ticas de ejemplo
- [ ] An√°lisis de pol√≠ticas (Cedar Analysis CLI)

### Fase 4: Documentaci√≥n (Sprint 5)
- [ ] Gu√≠a de migraci√≥n desde Express.js
- [ ] Ejemplos comparativos
- [ ] Best practices

---

## üìù Recomendaciones

### Inmediatas
1. **Priorizar extracci√≥n de entidades completas** - Cr√≠tico para pol√≠ticas complejas
2. **Implementar skipped_endpoints** - Necesario para rutas p√∫blicas
3. **Mejorar documentaci√≥n** - Comparativa con Express.js

### A Medio Plazo
1. **Crear herramientas CLI** - Generaci√≥n de schema y pol√≠ticas
2. **Ejemplos de migraci√≥n** - Facilitar adopci√≥n
3. **Benchmarks comparativos** - Demostrar ventajas de rendimiento

### A Largo Plazo
1. **Soporte para otros frameworks** - Actix, Rocket, Warp
2. **Plugin system** - Extensibilidad
3. **Dashboard web** - Gesti√≥n visual de pol√≠ticas

---

## üîó Referencias

- [Cedar Authorization for Express.js](https://github.com/cedar-policy/cedar-authorization-for-expressjs)
- [Hodei SDK Documentation](../sdk/README.md)
- [Middleware Guide](../sdk/docs/MIDDLEWARE_GUIDE.md)
- [Cedar Policy Language](https://www.cedarpolicy.com/)

---

## üìä Matriz de Compatibilidad

| Caracter√≠stica | Express.js | Hodei SDK | Compatibilidad | Prioridad |
|----------------|------------|-----------|----------------|-----------|
| Middleware Layer | ‚úÖ | ‚úÖ | 100% | - |
| Schema Support | ‚úÖ | ‚úÖ | 100% | - |
| Cedar Engine | ‚úÖ | ‚úÖ | 100% | - |
| JWT Token Auth | ‚úÖ | ‚úÖ | 100% | - |
| Custom Extractor | ‚úÖ | ‚ö†Ô∏è | 60% | üî¥ Alta |
| Entity Attributes | ‚úÖ | ‚ùå | 0% | üî¥ Cr√≠tica |
| Skipped Endpoints | ‚úÖ | ‚ùå | 0% | üü° Media |
| Context Config | ‚úÖ | ‚ö†Ô∏è | 40% | üü° Media |
| Logging | ‚úÖ | ‚úÖ | 120% | - |
| Error Handling | ‚úÖ | ‚úÖ | 100% | - |
| Schema Generation | ‚úÖ | ‚ùå | 0% | üü¢ Baja |
| Policy Generation | ‚úÖ | ‚ùå | 0% | üü¢ Baja |

**Compatibilidad Global: 68%**

---

## ‚úÖ Conclusiones

### Fortalezas
1. ‚úÖ Arquitectura m√°s robusta (gRPC + cache centralizado)
2. ‚úÖ Mejor rendimiento (~100Œºs vs ~ms)
3. ‚úÖ Type safety superior (Rust)
4. ‚úÖ Logging estructurado avanzado

### Debilidades
1. ‚ùå Falta soporte para entidades con atributos
2. ‚ùå No hay endpoints excluidos
3. ‚ùå Falta herramientas CLI (schema/policy generation)

### Prioridades
1. üî¥ **Cr√≠tico:** Implementar extracci√≥n de entidades completas
2. üü° **Importante:** A√±adir skipped_endpoints
3. üü¢ **Nice to have:** Herramientas CLI

---

**√öltima actualizaci√≥n:** 2025-10-21  
**Autor:** An√°lisis de Alineaci√≥n Hodei SDK
