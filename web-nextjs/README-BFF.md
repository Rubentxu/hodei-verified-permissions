# Hodei Verified Permissions - BFF (Backend for Frontend)\n\nEste directorio contiene el Backend for Frontend implementado en Next.js que sirve como proxy HTTP/gRPC para comunicarse con el servidor Rust de Hodei Verified Permissions.\n\n## 🏗️ Arquitectura\n\n```\nFrontend (React) → Next.js BFF (HTTP) → Rust gRPC Server\n```\n\nEl BFF:\n- **Recibe** solicitudes HTTP REST del frontend\n- **Traduce** las solicitudes a llamadas gRPC\n- **Se comunica** con el backend Rust via gRPC\n- **Devuelve** respuestas HTTP al frontend\n\n## 📁 Estructura de Archivos\n\n```\nweb-nextjs/\n├── src/\n│   ├── lib/grpc/\n│   │   └── node-client.ts          # Cliente gRPC con TypeScript\n│   └── pages/api/                   # API Routes (BFF endpoints)\n│       ├── authorize.ts             # Autorización principal\n│       ├── health.ts                # Health check\n│       ├── policy-stores.ts         # Crear policy stores\n│       ├── policy-stores/\n│       │   ├── list.ts              # Listar policy stores\n│       │   └── [id].ts              # Obtener policy store específico\n│       │   └── schema.ts            # Gestionar schemas (GET/PUT)\n│       └── test-authorization.ts    # Testing de autorización\n├── pages/\n│   └── authorization-test.tsx      # Frontend de testing\n└── next.config.js                   # Configuración optimizada para gRPC\n```\n\n## 🚀 API Endpoints\n\n### Data Plane\n\n#### `POST /api/authorize`\nRealiza una verificación de autorización.\n\n```json\n{\n  \"policy_store_id\": \"string\",\n  \"principal\": {\n    \"entity_type\": \"User\",\n    \"entity_id\": \"alice\"\n  },\n  \"action\": {\n    \"entity_type\": \"Action\",\n    \"entity_id\": \"viewDocument\"\n  },\n  \"resource\": {\n    \"entity_type\": \"Document\",\n    \"entity_id\": \"doc123\"\n  },\n  \"context\": \"{}\",\n  \"entities\": []\n}\n```\n\n### Control Plane\n\n#### `POST /api/policy-stores`\nCrear un nuevo policy store.\n\n```json\n{\n  \"description\": \"Policy store for documents\"\n}\n```\n\n#### `GET /api/policy-stores/list`\nListar todos los policy stores.\n\nQuery params:\n- `max_results` (opcional): número máximo de resultados\n- `next_token` (opcional): token de paginación\n\n#### `GET /api/policy-stores/[id]`\nObtener un policy store específico.\n\n#### `PUT /api/policy-stores/[id]/schema`\nActualizar el schema de un policy store.\n\n```json\n{\n  \"schema\": \"entity User {}; entity Document {};\"\n}\n```\n\n#### `GET /api/policy-stores/[id]/schema`\nObtener el schema de un policy store.\n\n#### `POST /api/test-authorization`\nProbar autorización con políticas temporales.\n\n```json\n{\n  \"policy_store_id\": \"test\",\n  \"schema\": \"entity User {}; entity Document {};\",\n  \"policies\": [\"permit User, Action, Document;\"],\n  \"principal\": {\"entity_type\": \"User\", \"entity_id\": \"alice\"},\n  \"action\": {\"entity_type\": \"Action\", \"entity_id\": \"view\"},\n  \"resource\": {\"entity_type\": \"Document\", \"entity_id\": \"doc1\"},\n  \"context\": \"{}\",\n  \"entities\": []\n}\n```\n\n### Health Check\n\n#### `GET /api/health`\nVerifica la salud del BFF y la conectividad con el backend gRPC.\n\n## 🛠️ Desarrollo\n\n### Prerrequisitos\n- Node.js 18+\n- Servidor Rust de Hodei Verified Permissions corriendo en `localhost:50051`\n\n### Instalación\n\n```bash\ncd web-nextjs\nnpm install\n```\n\n### Modo Desarrollo\n\n```bash\n# Usando Makefile (recomendado)\nmake bff-dev\n\n# O directamente\nnpm run dev\n```\n\n### Build Producción\n\n```bash\n# Usando Makefile (recomendado)\nmake bff-build\n\n# O directamente\nnpm run build\n```\n\n### Testing\n\n```bash\n# Health check del BFF\nmake bff-health\n\n# Probar conectividad gRPC\nmake bff-test\n\n# Acceder a la interfaz de testing\n# Abre http://localhost:3000/authorization-test\n```\n\n## 🔧 Configuración\n\n### Variables de Entorno\n\n- `VERIFIED_PERMISSIONS_ADDR`: Dirección del servidor gRPC (default: `localhost:50051`)\n\n### Configuración Next.js\n\nEl `next.config.js` está optimizado para:\n- Incluir paquetes gRPC en el build server-side\n- Manejar correctamente los módulos gRPC\n- Soportar TypeScript estricto\n\n## 🧪 Testing\n\n### Interfaz Web de Testing\n\nAccede a `http://localhost:3000/authorization-test` para:\n- Probar autorizaciones en tiempo real\n- Verificar health del sistema\n- Experimentar con diferentes políticas\n\n### Testing API\n\n```bash\n# Health check\ncurl http://localhost:3000/api/health\n\n# Autorización\ncurl -X POST http://localhost:3000/api/authorize \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"policy_store_id\": \"test\",\n    \"principal\": {\"entity_type\": \"User\", \"entity_id\": \"alice\"},\n    \"action\": {\"entity_type\": \"Action\", \"entity_id\": \"view\"},\n    \"resource\": {\"entity_type\": \"Document\", \"entity_id\": \"doc1\"}\n  }'\n```\n\n## 🚨 Manejo de Errores\n\nEl BFF implementa:\n- Validación de request parameters\n- Manejo robusto de errores gRPC\n- Logging detallado para debugging\n- Respuestas HTTP consistentes\n\n## 📝 Logs\n\nLos logs del BFF se muestran en la consola donde se ejecuta `npm run dev`.\n\nPara errores gRPC:\n- Se loguea el error completo del servidor Rust\n- Se devuelve un mensaje amigable al cliente\n- Se incluye el código de estado HTTP apropiado\n\n## 🔗 Integración con Frontend\n\nEl frontend puede consumir estos endpoints usando:\n- `fetch` nativo\n- Axios\n- React Query/TanStack Query\n- Cualquier cliente HTTP\n\nEjemplo con fetch:\n\n```javascript\nconst response = await fetch('/api/authorize', {\n  method: 'POST',\n  headers: { 'Content-Type': 'application/json' },\n  body: JSON.stringify({\n    policy_store_id: 'my-store',\n    principal: { entity_type: 'User', entity_id: 'alice' },\n    action: { entity_type: 'Action', entity_id: 'viewDocument' },\n    resource: { entity_type: 'Document', entity_id: 'doc123' }\n  })\n});\n\nconst result = await response.json();\nconsole.log('Authorization decision:', result.decision);\n```\n\n## 🎯 Mejores Prácticas\n\n1. **Siempre validar** la estructura de entity identifiers\n2. **Manejar errores** gRPC correctamente en el frontend\n3. **Usar context** para información adicional de autorización\n4. **Implementar caching** para policy stores frecuentemente usados\n5. **Monitorear health** del sistema regularmente\n\n## 🐛 Troubleshooting\n\n### Problema: \"gRPC error: connect ECONNREFUSED\"\n**Solución**: Asegúrate que el servidor Rust está corriendo en `localhost:50051`\n\n### Problema: \"Missing required fields\"\n**Solución**: Verifica que todos los campos requeridos estén presentes en el request\n\n### Problema: \"Method not allowed\"\n**Solución**: Usa el método HTTP correcto para cada endpoint\n\n## 📚 Documentación Adicional\n\n- [Documentación oficial de Hodei Verified Permissions](../README.md)\n- [Protocol Buffers - authorization.proto](../proto/authorization.proto)\n- [Makefile - Targets disponibles](../Makefile)
